(function($){$.fn.extend({mapify:function(options){var settings=$.extend({height:'200px',lat:0,lng:0,lock:'unlock',lat_input:'mapify_lat',lng_input:'mapify_lng',lock_input:'mapify_lock',},options);var that=$(this);return this.each(function(){that.wrap('<div class="mapify"><span class="geo-tag"></span></div>');var mapifyEl=that.parents('.mapify');var geotagEl=that.parent('.geo-tag');mapifyEl.data('lock_status',settings.lock);if(!$("#"+settings.id).length){mapifyEl.append('<div class="map-canvas" style="width:100%;height:'+settings.height+';"></div>')}
var lock_text='unlock'==settings.lock?mapifyl10n.locked:mapifyl10n.unlocked;var lock_class='unlock'==settings.lock?'unlocked':'locked';mapifyEl.append('<div class="map-canvas-options"><span class="map-action-lock '+lock_class+'" data-lock_status="'+settings.lock+'" data-lock="'+mapifyl10n.locked+'" data-unlock="'+mapifyl10n.unlocked+'">'+lock_text+'</span></div>');mapifyEl.append('<input autocomplete="off" type="hidden" name="'+settings.lock_input+'" value="'+settings.lock+'">');mapifyEl.append('<input autocomplete="off" type="hidden" name="'+settings.lat_input+'" value="'+settings.lat+'">');mapifyEl.append('<input autocomplete="off" type="hidden" name="'+settings.lng_input+'" value="'+settings.lng+'">');var addressInput=that;var mapCanvas=mapifyEl.find('.map-canvas');var lockInput=mapifyEl.find('input[name="'+settings.lock_input+'"]');var latInput=mapifyEl.find('input[name="'+settings.lat_input+'"]');var lngInput=mapifyEl.find('input[name="'+settings.lng_input+'"]');var map;var marker;var pos;var geocoder;var addressAutoComplete;var mapifyHandler={init:function(){mapifyHandler.loadMap();mapifyHandler.loadAddressAutoComplete();mapifyHandler.geoTag();mapifyHandler.toggleLock()},loadMap:function(){geocoder=new google.maps.Geocoder();pos=new google.maps.LatLng(settings.lat,settings.lng);map=new google.maps.Map(mapCanvas[0],{center:pos,zoom:13,streetViewControl:!1});var marker_dragable='unlock'==mapifyEl.data('lock_status')?!0:!1;marker=new google.maps.Marker({map:map,draggable:marker_dragable,animation:google.maps.Animation.DROP,anchorPoint:new google.maps.Point(0,-29),position:pos,});google.maps.event.addListener(marker,'dragend',function(event){if('unlock'==mapifyEl.data('lock_status')){var pos=event.latLng;var lat=pos.lat();var lng=pos.lng();mapifyHandler.updatePosition(lat,lng,pos);mapifyHandler.updateAddress(pos)}});google.maps.event.addDomListener(window,'resize',function(){var center=map.getCenter();google.maps.event.trigger(map,'resize');map.setCenter(center)});mapifyEl.on('mapify_resize',function(){var center=map.getCenter();google.maps.event.trigger(map,'resize');map.setCenter(center)})},geoTag:function(){if(navigator.geolocation){var is_chrome=/chrom(e|ium)/.test(navigator.userAgent.toLowerCase());var is_ssl='https:'==document.location.protocol;if(is_chrome&&!is_ssl){return!1}
geotagEl.prepend('<i class="location"></i>');geotagEl.children('.location').click(function(e){e.preventDefault();var icon=$(this);icon.addClass('loading');navigator.geolocation.getCurrentPosition(function(position){var lat=position.coords.latitude;var lng=position.coords.longitude;var pos=new google.maps.LatLng(lat,lng);mapifyHandler.updatePosition(lat,lng,pos);marker.setPosition(pos);mapifyHandler.updateAddress(pos);icon.removeClass('loading')},function(){icon.removeClass('loading')})})}},loadAddressAutoComplete:function(){addressAutoComplete=new google.maps.places.Autocomplete(addressInput[0]);addressAutoComplete.bindTo('bounds',map);google.maps.event.addListener(addressAutoComplete,'place_changed',function(){if('unlock'==mapifyEl.data('lock_status')){var place=addressAutoComplete.getPlace();if(undefined!==place){var pos=place.geometry.location;var lat=pos.lat();var lng=pos.lng();mapifyHandler.updatePosition(lat,lng,pos);marker.setPosition(pos)}}});google.maps.event.addDomListener(addressInput[0],'keydown',function(e){if(e.keyCode==13){e.preventDefault()}})},toggleLock:function(){mapifyEl.find('.map-action-lock').click(function(e){e.preventDefault();var lockStatus=$(this).data('lock_status');if('unlock'==lockStatus){marker.setDraggable(!1);$(this).removeClass('locked unlocked').addClass('locked');$(this).text($(this).data('unlock'));$(this).data('lock_status','lock');lockStatus=$(this).data('lock_status');$(this).attr('data-lock_status',lockStatus);mapifyEl.data('lock_status',lockStatus);lockInput.val(lockStatus)}else{marker.setDraggable(!0);$(this).removeClass('locked unlocked').addClass('unlocked');$(this).text($(this).data('lock'));$(this).data('lock_status','unlock');lockStatus=$(this).data('lock_status');$(this).attr('data-lock_status',lockStatus);mapifyEl.data('lock_status',lockStatus);lockInput.val(lockStatus)}})},updatePosition:function(lat,lng,pos){latInput.val(lat);lngInput.val(lng);map.panTo(pos)},updateAddress:function(pos){geocoder.geocode({'latLng':pos},function(results,status){if(status==google.maps.GeocoderStatus.OK&&results[0]){addressInput.val(results[0].formatted_address)}})},};mapifyHandler.init()})},})}(jQuery))